// Ajwad Fuad Choudhury
// Compile: gcc -Wall -O3 -o decoder decoder.c -lfftw3 -lm
// Run: ./decoder M output_file.dat output_file_2.dat

#include <stdio.h>
#include <stdlib.h>
#include <stddef.h>
#include <stdint.h>
#include <math.h>
#include <fftw3.h>
#include <errno.h>
#include <string.h>
#include <time.h>

void disp(double in[], int size);
double * Interpolate(double *c, double *tail, double *filter, int D, int step, FILE * fptr);
double * Conv(double *in, double *bpf, double *tail);

const int N = 128;
const int M = 60;
const int Fs = 8000;
double T = 1/Fs;
double PI = 3.14159265359;
int m = 0;               // read file pointer start point
int n = 0;               // write file pointer
int b = 1;
double avg = 0;


int main(int argc, char *argv[]){

    // BPF Coefficients
    double bpf1[] = {-0.0278750880197804,-0.0257058119414838,-0.0233560402607081,-0.0208399886848616,-0.0181731192659842,-0.0153720378296469,-0.0124543823874235,-0.00943870333308697,-0.00634433628998448,-0.00319126853774036,0,0.00320860017908237,0.00641344040389785,0.00959335564655568,0.0127272575996101,0.0157942848333969,0.0187739518255370,0.0216462957356013,0.0243920198122761,0.0269926323435260,0.0294305800920594,0.0316893751986096,0.0337537145838553,0.0356095909358379,0.0372443944330474,0.0386470044234567,0.0398078703561148,0.0407190813438748,0.0413744238227659,0.0417694268647317,0.0419013947952288,0.0417694268647317,0.0413744238227659,0.0407190813438748,0.0398078703561148,0.0386470044234567,0.0372443944330474,0.0356095909358379,0.0337537145838553,0.0316893751986096,0.0294305800920594,0.0269926323435260,0.0243920198122761,0.0216462957356013,0.0187739518255370,0.0157942848333969,0.0127272575996101,0.00959335564655568,0.00641344040389785,0.00320860017908237,0,-0.00319126853774036,-0.00634433628998448,-0.00943870333308697,-0.0124543823874235,-0.0153720378296469,-0.0181731192659842,-0.0208399886848616,-0.0233560402607081,-0.0257058119414838,-0.0278750880197804};
    double bpf2[] = {-0.0254689792672038,-0.0267447662780950,-0.0276577559755439,-0.0281888995887381,-0.0283247589275050,-0.0280577949146657,-0.0273865630425079,-0.0263158114032987,-0.0248564785779797,-0.0230255903648649,-0.0208460560613278,-0.0183463667452935,-0.0155601997087412,-0.0125259348415647,-0.00928609032109386,-0.00588668640183949,-0.00237654739505432,0.00119344694557099,0.00477114847846243,0.00830395328528935,0.0117396264462671,0.0150271253100144,0.0181174075486062,0.0209642104878967,0.0235247886391615,0.0257605970236574,0.0276379087657051,0.0291283565172154,0.0302093885483607,0.0308646317730968,0.0310841555492425,0.0308646317730968,0.0302093885483607,0.0291283565172154,0.0276379087657051,0.0257605970236574,0.0235247886391615,0.0209642104878967,0.0181174075486062,0.0150271253100144,0.0117396264462671,0.00830395328528935,0.00477114847846243,0.00119344694557099,-0.00237654739505432,-0.00588668640183949,-0.00928609032109386,-0.0125259348415647,-0.0155601997087412,-0.0183463667452935,-0.0208460560613278,-0.0230255903648649,-0.0248564785779797,-0.0263158114032987,-0.0273865630425079,-0.0280577949146657,-0.0283247589275050,-0.0281888995887381,-0.0276577559755439,-0.0267447662780950,-0.0254689792672038};
    double bpf3[] = {-9.02416598363238e-18,-0.00483547536154385,-0.00962560074168419,-0.0142465041221349,-0.0185769420539919,-0.0225015826572982,-0.0259141708557918,-0.0287204865300896,-0.0308410110669256,-0.0322132250497919,-0.0327934693915581,-0.0325583137973744,-0.0315053897493343,-0.0296536598527013,-0.0270431109641319,-0.0237338745917660,-0.0198047941541036,-0.0153514743439835,-0.0104838626101088,-0.00532342620911181,9.53251476093418e-18,0.00535161019795385,0.0105951765724422,0.0155966537891604,0.0202277401631817,0.0243692975409086,0.0279145354991771,0.0307718717525581,0.0328673894593058,0.0341468231837559,0.0345770182946541,0.0341468231837559,0.0328673894593058,0.0307718717525581,0.0279145354991771,0.0243692975409086,0.0202277401631817,0.0155966537891604,0.0105951765724422,0.00535161019795385,9.53251476093418e-18,-0.00532342620911181,-0.0104838626101088,-0.0153514743439835,-0.0198047941541036,-0.0237338745917660,-0.0270431109641319,-0.0296536598527013,-0.0315053897493343,-0.0325583137973744,-0.0327934693915581,-0.0322132250497919,-0.0308410110669256,-0.0287204865300896,-0.0259141708557918,-0.0225015826572982,-0.0185769420539919,-0.0142465041221349,-0.00962560074168419,-0.00483547536154385,-9.02416598363238e-18};
    double bpf4[] = {0.0292712811544965,0.0265542989483833,0.0227568531456610,0.0180128418890895,0.0124961700597784,0.00641424455225677,-9.53467740448799e-18,-0.00649723177100516,-0.0128216426144993,-0.0187212556272449,-0.0239581948507555,-0.0283184894917747,-0.0316210001405630,-0.0337250872594286,-0.0345366914581430,-0.0340125587993251,-0.0321624199724094,-0.0290490164911362,-0.0247859565569087,-0.0195334740902123,-0.0134922527814037,-0.00689555905194815,-1.97458225429765e-17,0.00692471841036983,0.0136066140632555,0.0197823873856153,0.0252080637380127,0.0296688789432218,0.0329879977674171,0.0350337029407978,0.0357247554755213,0.0350337029407978,0.0329879977674171,0.0296688789432218,0.0252080637380127,0.0197823873856153,0.0136066140632555,0.00692471841036983,-1.97458225429765e-17,-0.00689555905194815,-0.0134922527814037,-0.0195334740902123,-0.0247859565569087,-0.0290490164911362,-0.0321624199724094,-0.0340125587993251,-0.0345366914581430,-0.0337250872594286,-0.0316210001405630,-0.0283184894917747,-0.0239581948507555,-0.0187212556272449,-0.0128216426144993,-0.00649723177100516,-9.53467740448799e-18,0.00641424455225677,0.0124961700597784,0.0180128418890895,0.0227568531456610,0.0265542989483833,0.0292712811544965};
    double bpf5[] = {0.0201387789203608,0.0244780034718571,0.0275140978344981,0.0290552196246015,0.0289920510186542,0.0273052955242289,0.0240680436162492,0.0194427994572429,0.0136732740558264,0.00707136093676049,4.33741827888813e-18,-0.00714711389491971,-0.0139678244446483,-0.0200745262823223,-0.0251165579568726,-0.0288006612482863,-0.0309082948561135,-0.0313087656313427,-0.0299673785854015,-0.0269480941346809,-0.0224105005954157,-0.0166012429445864,-0.00984037549518614,-0.00250340685719576,0.00499993771556093,0.0122490142825255,0.0188362704893262,0.0243905737827666,0.0285984991238544,0.0312223340878852,0.0321137492326746,0.0312223340878852,0.0285984991238544,0.0243905737827666,0.0188362704893262,0.0122490142825255,0.00499993771556093,-0.00250340685719576,-0.00984037549518614,-0.0166012429445864,-0.0224105005954157,-0.0269480941346809,-0.0299673785854015,-0.0313087656313427,-0.0309082948561135,-0.0288006612482863,-0.0251165579568726,-0.0200745262823223,-0.0139678244446483,-0.00714711389491971,4.33741827888813e-18,0.00707136093676049,0.0136732740558264,0.0194427994572429,0.0240680436162492,0.0273052955242289,0.0289920510186542,0.0290552196246015,0.0275140978344981,0.0244780034718571,0.0201387789203608};
    double bpf6[] = {-3.55335598115006e-05,-0.000124505157291136,-0.000295241326220093,-0.000545134698313132,-0.000818354494879952,-0.000986240673134544,-0.000847187563679165,-0.000157342012053242,0.00130358280495092,0.00363866685614022,0.00673294549760255,0.0101767524113071,0.0132481085331440,0.0149818612505857,0.0143348776082246,0.0104300158464852,0.00283332011027403,-0.00820264239538099,-0.0216030949161026,-0.0355036950611757,-0.0474793815518835,-0.0549508484310015,-0.0557009847022702,-0.0483952075132149,-0.0329838541466316,-0.0108786512222685,0.0151618103350251,0.0414393140964791,0.0639487808376888,0.0791123212548707,0.0844604418126764,0.0791123212548707,0.0639487808376888,0.0414393140964791,0.0151618103350251,-0.0108786512222685,-0.0329838541466316,-0.0483952075132149,-0.0557009847022702,-0.0549508484310015,-0.0474793815518835,-0.0355036950611757,-0.0216030949161026,-0.00820264239538099,0.00283332011027403,0.0104300158464852,0.0143348776082246,0.0149818612505857,0.0132481085331440,0.0101767524113071,0.00673294549760255,0.00363866685614022,0.00130358280495092,-0.000157342012053242,-0.000847187563679165,-0.000986240673134544,-0.000818354494879952,-0.000545134698313132,-0.000295241326220093,-0.000124505157291136,-3.55335598115006e-05};
    double bpf7[] = {-8.50502148324485e-05,-0.000136782825556884,-6.74245772512913e-05,0.000259771015777316,0.000921517357859530,0.00181527227754770,0.00257316877876277,0.00258986716433198,0.00121829161894697,-0.00188701342747284,-0.00639663069194829,-0.0110938437773728,-0.0140109259567311,-0.0129965679203407,-0.00660935755611081,0.00496637747859073,0.0193980355119956,0.0324359803075703,0.0390186847714035,0.0350147216877046,0.0190300962970305,-0.00644455207002707,-0.0351416362442428,-0.0585658712676970,-0.0686192385889225,-0.0604547161783653,-0.0345146090174673,0.00308966763579983,0.0421440493995610,0.0714191298983627,0.0822587913357212,0.0714191298983627,0.0421440493995610,0.00308966763579983,-0.0345146090174673,-0.0604547161783653,-0.0686192385889225,-0.0585658712676970,-0.0351416362442428,-0.00644455207002707,0.0190300962970305,0.0350147216877046,0.0390186847714035,0.0324359803075703,0.0193980355119956,0.00496637747859073,-0.00660935755611081,-0.0129965679203407,-0.0140109259567311,-0.0110938437773728,-0.00639663069194829,-0.00188701342747284,0.00121829161894697,0.00258986716433198,0.00257316877876277,0.00181527227754770,0.000921517357859530,0.000259771015777316,-6.74245772512913e-05,-0.000136782825556884,-8.50502148324485e-05};
    double bpf8[] = {6.89185346518009e-09,4.41857385742365e-07,2.23824612930771e-06,2.24733859007911e-06,-1.05553964273802e-05,-3.76228894942537e-05,-4.34605516863897e-05,7.60403364432873e-06,4.77927425253768e-05,-4.72039201645906e-05,-0.000120912403467443,0.000391086274853950,0.00163762702345985,0.00221891922505603,-2.40897154797473e-18,-0.00460856909773297,-0.00709797094382857,-0.00357206936616168,0.00236288205644122,0.00201633317475485,-0.00459255541502317,-0.00170737166564072,0.0239692316675178,0.0544651833361478,0.0439106212350341,-0.0305681972396200,-0.121478977237799,-0.136919156362781,-0.0339983473444200,0.118358333787572,0.190824688519157,0.118358333787572,-0.0339983473444200,-0.136919156362781,-0.121478977237799,-0.0305681972396200,0.0439106212350341,0.0544651833361478,0.0239692316675178,-0.00170737166564072,-0.00459255541502317,0.00201633317475485,0.00236288205644122,-0.00357206936616168,-0.00709797094382857,-0.00460856909773297,-2.40897154797473e-18,0.00221891922505603,0.00163762702345985,0.000391086274853950,-0.000120912403467443,-4.72039201645906e-05,4.77927425253768e-05,7.60403364432873e-06,-4.34605516863897e-05,-3.76228894942537e-05,-1.05553964273802e-05,2.24733859007911e-06,2.23824612930771e-06,4.41857385742365e-07,6.89185346518009e-09};
    double bpf9[] = {4.42146389969161e-08,-2.09017623535731e-21,-2.57867666824769e-06,2.42015280821410e-20,1.34699624008506e-05,-5.16893436757463e-20,1.83239579553634e-19,2.02853794204192e-20,-0.000204872934490987,-2.12393689997895e-19,0.000811916324372959,-1.36491234387736e-18,-0.00139636648949775,1.09315072470054e-18,-1.05285579786423e-18,2.00330463168940e-18,0.00605227480214081,-1.83079887715816e-17,-0.0158665485026863,-3.80179955945482e-18,0.0196868866478771,-7.12921709994395e-18,5.77317471523697e-18,-4.65600414444691e-18,-0.0560352632042933,3.11892241240921e-17,0.139955566183687,-7.10383454982659e-17,-0.218116165980615,0,0.250203303378912,0,-0.218116165980615,-7.10383454982659e-17,0.139955566183687,3.11892241240921e-17,-0.0560352632042933,-4.65600414444691e-18,5.77317471523697e-18,-7.12921709994395e-18,0.0196868866478771,-3.80179955945482e-18,-0.0158665485026863,-1.83079887715816e-17,0.00605227480214081,2.00330463168940e-18,-1.05285579786423e-18,1.09315072470054e-18,-0.00139636648949775,-1.36491234387736e-18,0.000811916324372959,-2.12393689997895e-19,-0.000204872934490987,2.02853794204192e-20,1.83239579553634e-19,-5.16893436757463e-20,1.34699624008506e-05,2.42015280821410e-20,-2.57867666824769e-06,-2.09017623535731e-21,4.42146389969161e-08};
    double bpf10[] = {-2.28253404937516e-08,-1.14603048456339e-07,1.25996193103388e-06,-1.38153150670063e-06,-6.92383467544277e-06,1.98702496298104e-05,-8.04891490820067e-07,-7.32372940395925e-05,9.98522646781073e-05,9.86943636750187e-05,-0.000411999619287062,0.000255456200465386,0.000683668960532563,-0.00134184189699164,-2.69863059389512e-05,0.00286385316922795,-0.00307069593500752,-0.00218578146225980,0.00785212031353406,-0.00395034463807189,-0.00994468789968709,0.0169005804556719,-0.000147978227192986,-0.0279991862792851,0.0278082987513704,0.0200979730990104,-0.0701405829516982,0.0379919127717972,0.108727394947949,-0.291473345499883,0.374749988267343,-0.291473345499883,0.108727394947949,0.0379919127717972,-0.0701405829516982,0.0200979730990104,0.0278082987513704,-0.0279991862792851,-0.000147978227192986,0.0169005804556719,-0.00994468789968709,-0.00395034463807189,0.00785212031353406,-0.00218578146225980,-0.00307069593500752,0.00286385316922795,-2.69863059389512e-05,-0.00134184189699164,0.000683668960532563,0.000255456200465386,-0.000411999619287062,9.86943636750187e-05,9.98522646781073e-05,-7.32372940395925e-05,-8.04891490820067e-07,1.98702496298104e-05,-6.92383467544277e-06,-1.38153150670063e-06,1.25996193103388e-06,-1.14603048456339e-07,-2.28253404937516e-08};

    // BPF Tails
    double tail1[60]={0}, tail2[60]={0}, tail3[60]={0}, tail4[60]={0}, tail5[60]={0}, tail6[60]={0}, tail7[60]={0}, tail8[60]={0}, tail9[60]={0}, tail10[60]={0};

    // LPF Tails
    double itail1[60]={0}, itail2[60]={0}, itail3[60]={0}, itail4[60]={0}, itail5[60]={0}, itail6[60]={0}, itail7[60]={0}, itail8[60]={0}, itail9[60]={0}, itail10[60]={0};
    
    FILE *fin, *fout;
    double c[N], sum[N];
    double *c1, *c2, *c3, *c4, *c5, *c6, *c7, *c8, *c9, *c10;                           // BPF Random Signals
    //double in[64*10];
    // double *d_env1, *d_env2, *d_env3, *d_env4, *d_env5, *d_env6, *d_env7, *d_env8, *d_env9, *d_env10; 
    double *env1, *env2, *env3, *env4, *env5, *env6, *env7, *env8, *env9, *env10;       // Interpolated Envelops
    double lpf[61];

    // argv[1] - Decimation Factor
    int D = atoi(argv[1]);
    if (D <= 0){
        printf("\nError: Decimation Factor of %d is Invalid\n", atoi(argv[1]));
        exit(1);
    }

    // argv[2] - input file name
    fin = fopen(argv[2],"rb");                                                               // open file

	if(fin == NULL) {
		printf("ERROR: %s does not exist\n",argv[2]);                                        // If file does not exists
		exit(1);    
	}else{
        printf("Reading File...\n");
    }

    // arg[3] - output file name
    fout = fopen(argv[3],"w+b");
	if(fout == NULL) {
		printf("ERROR: %s cannot be created\n",argv[3]);
		exit(1);
	}

    // get file size
    fseek(fin, 0L, SEEK_END);
    int file_size = ftell(fin)/(N/D*10);
    int N_blk = ftell(fin)/N;  
    rewind(fin);


    printf("Input File: %s\n", argv[2]);
    printf("Output File: %s\n", argv[3]);
    printf("Decimation Factor: %d \n", D);
    // printf("N_blk: %d", N_blk);
    printf("file size: %d\n", file_size/10*D);

    int step = floor(N/D);

    // 1) Generate random sequence
    srand(time(0));
    for (int i=0;i<128;i++)
        c[i] = (double) rand()/RAND_MAX;
    
    
    // 2) Filter sequence across all BPF filters  <--- do you need tail if youre just doing convolution once?????
    c1 = Conv(c, bpf1, tail1);
    c2 = Conv(c, bpf2, tail2);
    c3 = Conv(c, bpf3, tail3);
    c4 = Conv(c, bpf4, tail4);
    c5 = Conv(c, bpf5, tail5);
    c6 = Conv(c, bpf6, tail6);
    c7 = Conv(c, bpf7, tail7);
    c8 = Conv(c, bpf8, tail8);
    c9 = Conv(c, bpf9, tail9);
    c10 = Conv(c, bpf10, tail10);

    // 3) Generate Low-Pass Filter Coefficients
    double theta = PI/D;  
    int k = 0; 
    for (int i = 0; i < M; i++){
        if (i == 0){
            lpf[i] =  theta/PI;
            //printf("%f\n",lpf[k]);
            k++;
            continue;
        }
        lpf[i] = sin(theta*k)/(PI*k); //*(0.42 + 0.5*cos(2*PI*k/(2*30-1)) + 0.08*cos(4*PI*n/(2*30-1)));
        //printf("%f\n",lpf[k]);
        k++;
    
    }
   
    // Block Convolution
    for (int i = 0; i < file_size; i++){

        double run_time = 0.0;
        clock_t begin = clock();
        
        // Fetch, interpolate and multiply with carrier
        env1 = Interpolate(c1, itail1, lpf, D, step, fin);
        env2 = Interpolate(c2, itail2, lpf, D, step, fin);
        env3 = Interpolate(c3, itail3, lpf, D, step, fin);
        env4 = Interpolate(c4, itail4, lpf, D, step, fin);
        env5 = Interpolate(c5, itail5, lpf, D, step, fin);
        env6 = Interpolate(c6, itail6, lpf, D, step, fin);
        env7 = Interpolate(c7, itail7, lpf, D, step, fin);
        env8 = Interpolate(c8, itail8, lpf, D, step, fin);
        env9 = Interpolate(c9, itail9, lpf, D, step, fin);
        env10 = Interpolate(c10, itail10, lpf, D, step, fin);

        // sum all results together and convert to int16_t
        int16_t out[N];

        for (int i = 0; i < N; i++){
            sum[i] = (env1[i] + env2[i] + env3[i] + env4[i] + env5[i] + env6[i] + env7[i] + env8[i] + env9[i] + env10[i])*(pow(2, 15)-1); 
            out[i] = sum[i];   
        }
        
        // write to file
        fseek(fout, n*sizeof(int16_t), SEEK_SET);
        fwrite(out, N, 1, fout);
        n += N;                         // increment output file pointer

        clock_t end = clock();
        run_time = (double)(end - begin) / CLOCKS_PER_SEC;
        printf("Block %d Run Time: %.3f ms\n", b, run_time*1e3);      // print runtime of each block convolution
        avg += run_time;
        b++;
    
    }

    printf("\nDecoding Finished\n");
    printf("\nAverage Block Time: %.3f ms\n", (avg/b)*1e3);
    printf("\nTotal Run Time: %.3f s\n", avg);
    printf("\nDecoded Speech (int16_t) Saved to: %s\n", argv[3]);

    return 0;
}

// Display Contents of an Array
void disp(double in[], int size){
    printf("\n");
    for (int i = 0; i < size; i++){
        printf("Element %d: %f \n", i, in[i]);
    }

}


double * Conv(double *in, double *filter, double *tail){
	size_t j;
	double *array1, *array2, *array_res, *array1_fft, *array2_fft, *array_res_fft, *out;  // pointers to the array 
	fftw_plan pfft1, pfft2, pifft;

    array1        = fftw_malloc((N+M-1)*sizeof(double));   // allocate memory size to each of the arrays and returns pointer
	array2        = fftw_malloc((N+M-1)*sizeof(double));   
	array1_fft    = fftw_malloc((N+M-1)*sizeof(double));
	array2_fft    = fftw_malloc((N+M-1)*sizeof(double));
	array_res     = fftw_malloc((N+M-1)*sizeof(double));   // ifft( multiplied FFTs )
	array_res_fft = fftw_malloc((N+M-1)*sizeof(double));   // multiplied FFTs
    out           = fftw_malloc((N)*sizeof(double));


    // Set FFT Plans 
	pfft1 = fftw_plan_r2r_1d(N+M-1, array1, array1_fft, FFTW_R2HC, FFTW_ESTIMATE);         // FFT of array1
	pfft2 = fftw_plan_r2r_1d(N+M-1, array2, array2_fft, FFTW_R2HC, FFTW_ESTIMATE);         // FFT of array2
	pifft = fftw_plan_r2r_1d(N+M-1, array_res_fft, array_res, FFTW_HC2R, FFTW_ESTIMATE);   // IFFT of FFT(array1)*FFT(array2)

    // Fill array1, array 2 and FFTs with zeros
    memset(array1, 0, (N+M-1)*sizeof(double));
	memset(array2, 0, (N+M-1)*sizeof(double));
	memset(array1_fft, 0, (N+M-1)*sizeof(double));
	memset(array2_fft, 0, (N+M-1)*sizeof(double));

    // Fill padded arrays with input sample and impulse response
    for (int j = 0; j < N; j++){
        array1[j] = in[j];
    }

    // Pre-pad the impulse responses to get rid of this FOR loop !!!
    for (int j = 0; j < M; j++){
        array2[j] = filter[j];
    }

	//calculate the FFTs
	fftw_execute(pfft1);
	fftw_execute(pfft2);
    
    //multiply the two FFTs
	array_res_fft[0] = array1_fft[0]*array2_fft[0];
	for(j=1;j<((N+M-1)+1)/2;j++) {
		array_res_fft[j]          = array1_fft[j]*array2_fft[j]-array1_fft[N+M-1-j]*array2_fft[N+M-1-j]; //real
		array_res_fft[N+M-1-j] = array1_fft[N+M-1-j]*array2_fft[j]+array1_fft[j]*array2_fft[N+M-1-j]; //imag
	}
    if((N+M-1) % 2 == 0)
		array_res_fft[(N+M-1)/2] = array1_fft[(N+M-1)/2]*array2_fft[(N+M-1)/2];
    
	//calculate the inverse FFT
	fftw_execute(pifft);

    for (j = 0; j < N+M-1; j++)
        array_res[j] /= N+M-1;

    // add tail to final convolution
    for (j = 0; j < (M-1); j++)
        array_res[j] += tail[j];
    
    // Compute new tail for next convolution
    int n = 0;
    for (j = N; j < N+M-1; j++){
        tail[n] = array_res[j];
        n += 1;
    }

    // Extract Output Frame (First N Samples of Convolution)
    for (j = 0; j < N; j++)
        out[j] = array_res[j];


    fftw_destroy_plan(pfft1);
	fftw_destroy_plan(pfft2);
	fftw_destroy_plan(pifft); 
	fftw_free(array1);
	fftw_free(array2);
	fftw_free(array1_fft);
	fftw_free(array2_fft);
	fftw_free(array_res);
	fftw_free(array_res_fft);

    return out;
}

double * Interpolate(double *c, double *tail, double *filter, int D, int step, FILE *fptr){
    // LPF Coefficients
    //double lpf[] = {-0.00611815975316102,-0.00840549057673132,-0.00957154017224517,-0.00930888604512227,-0.00750554783488226,-0.00428271457318357,4.33928934241786e-18,0.00477553912899790,0.00933522998070562,0.0129227379032602,0.0148447207604758,0.0145834032592916,0.0118948744209396,0.00687775549380104,-4.71679438542454e-18,-0.00792335021327769,-0.0158022409675283,-0.0223874311568263,-0.0264175826761028,-0.0267801212898182,-0.0226655243662628,-0.0136944876932398,4.95126110578289e-18,0.0177485416709022,0.0383850227444341,0.0603479164158590,0.0818330154075457,0.100980527961130,0.116074672438718,0.125731854488681,0.129054530487279,0.125731854488681,0.116074672438718,0.100980527961130,0.0818330154075457,0.0603479164158590,0.0383850227444341,0.0177485416709022,4.95126110578289e-18,-0.0136944876932398,-0.0226655243662628,-0.0267801212898182,-0.0264175826761028,-0.0223874311568263,-0.0158022409675283,-0.00792335021327769,-4.71679438542454e-18,0.00687775549380104,0.0118948744209396,0.0145834032592916,0.0148447207604758,0.0129227379032602,0.00933522998070562,0.00477553912899790,4.33928934241786e-18,-0.00428271457318357,-0.00750554783488226,-0.00930888604512227,-0.00957154017224517,-0.00840549057673132,-0.00611815975316102};
    uint8_t in[step];
    double dec_env[step];
    double *env, *int_env;

    env = malloc(D*step*sizeof(double));
    memset(env, 0, D*step*sizeof(double));

    fseek(fptr, m*sizeof(uint8_t), SEEK_SET);            // set read start point relative to beginning of file    
    fread(&in, sizeof(in), 1, fptr);                     // fetch 128 sample block


    // convert from uint8_t encoding to decimal
    for (int i = 0; i < step; i++)
        dec_env[i] = (int) in[i]/(pow(2,7)-1);

    int j = 0;
    // pad M-1 zeros between each sample
    for (int i = 0; i < D*step; i = i + D){
        env[i] = dec_env[j];
        j += 1;
    }

    int_env = Conv(env, filter, tail);

    for (int i = 0; i < N; i++)
        int_env[i] *= c[i];


    m += step;  // increment file pointer start point to next envelop

    return int_env;
}
